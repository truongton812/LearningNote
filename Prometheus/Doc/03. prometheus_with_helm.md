
<img width="921" height="508" alt="prometheus_custom_resource" src="https://github.com/user-attachments/assets/8a02dc27-987f-43db-bcbe-53f01511e978" />



Khi cài Prometheus bằng Helm chart (ví dụ: kube-prometheus-stack), Helm sẽ deploy operator, tạo đầy đủ các CRD liên quan và việc của DevOps chỉ là tạo các các Custom Resource (hay còn gọi là Object) như Prometheus, AlertManager, khi đó Operator sẽ thực hiện cài đặt và cấu hình cho Prometheus Server hoặc AlertManager sẽ do Prometheus Operatr thực thi

Operator sẽ theo dõi state của các custom resource mà nó quản lý (như Prometheus, ServiceMonitor,...), từ đó thực thi các thao tác tự động dựa trên khai báo trong CR (ví dụ: tự động deploy Prometheus, cấu hình scrape, quản lý HA,...).

Operator sẽ chạy một control loop, liên tục reconcile (đồng bộ) trạng thái thực tế trong cluster với trạng thái mong muốn khai báo trong các CR.

Ví dụ: Khai báo một đối tượng kiểu ServiceMonitor mô tả dịch vụ Kubernetes A, operator sẽ tự động sinh cấu hình scrape cho Prometheus để giám sát endpoint của service này, mà không cần chỉnh file cấu hình prometheus.yml thủ công.

Tóm tắt các thành phần và chức năng chính

| CRD/CR               | Mục đích cấu hình                                                          |
|----------------------|----------------------------------------------------------------------------|
| Prometheus           | Định nghĩa instance Prometheus, số replica, lưu trữ,...                    |
| Alertmanager         | Khai báo cluster Alertmanager để xử lý cảnh báo                            |
| ServiceMonitor       | Định nghĩa các đối tượng cần scrape metric (IP, port, url, path, api, interval...), selector label,...                      |
| PodMonitor           | Tương tự ServiceMonitor nhưng giám sát pod                                 |
| PrometheusRule       | Tạo tập hợp rule alerting, recording rule                                  |
| Probe                | Định nghĩa static target, ingress cho Prometheus                           |
| AlertmanagerConfig   | Cấu hình chi tiết routing alert, ức chế cảnh báo                           |

VD như bình thường nếu muốn thêm target để monitor thì ta cần update file prometheus.yaml để thêm target rồi restart prometheus để apply, còn nếu thông qua k8s thì ta chỉ cần tạo resource ServiceMonitor -> Prometheus Operator sẽ tự động đọc và update vào config của Prometheus

Lưu ý 1:

Trong Kubernetes với Prometheus Operator, ta có thể tạo nhiều đối tượng custom resource kiểu ServiceMonitor để định nghĩa các tập hợp các dịch vụ, pod hoặc endpoint mà Prometheus có thể scrape metrics.

Tuy nhiên, không phải lúc nào Prometheus Server cũng sẽ scrape tất cả các đối tượng target do tất cả các ServiceMonitor định nghĩa.

Lý do là trong cấu hình của custom resource Prometheus (định nghĩa instance Prometheus Server) có một trường selector dùng để lọc các ServiceMonitor mà nó sẽ chú ý đến. Trường selector này chọn các ServiceMonitor dựa trên nhãn (label) hoặc namespace của ServiceMonitor.

Vì vậy, Prometheus Server chỉ scrape các target từ những ServiceMonitor thỏa mãn selector đã khai báo trong custom resource Prometheus.

VD:
```
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: example-prometheus
  namespace: monitoring
spec:
  serviceMonitorSelector:
    matchLabels:
      team: frontend
  # hoặc:
  # serviceMonitorSelector:
  #   matchExpressions:
  #     - key: team
  #       operator: In
  #       values:
  #         - frontend
  #         - backend
  serviceMonitorNamespaceSelector:
    matchNames:
      - monitoring
```


Lưu ý 2:

ServiceMonitor cũng có thuộc tính selector trong phần spec, có nhiệm vụ chọn các đối tượng Kubernetes (như Service, Pod) mà ServiceMonitor sẽ theo dõi để scrape metrics.

spec.selector là một label selector để lọc các Kubernetes Service hoặc Pod mà ServiceMonitor quan tâm.

Các Service hoặc Pod phải có nhãn (label) khớp với selector này để bị Prometheus scrape qua ServiceMonitor.

spec.namespaceSelector giới hạn namespace nơi tìm kiếm các đối tượng service hoặc pod.

Ngoài ra spec.endpoints định nghĩa các port, path, interval để Prometheus scrape metric từ các target được chọn.

Ví dụ mẫu ServiceMonitor khai báo selector:

```
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: example-servicemonitor
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: my-app
  namespaceSelector:
    matchNames:
      - default
  endpoints:
    - port: http-metrics
      path: /metrics
      interval: 30s
```

ServiceMonitor chủ yếu dùng để monitor các thành phần trong cụm Kubernetes như Services và Pods. Nó hoạt động dựa trên việc chọn các đối tượng nội bộ cluster có nhãn (label) thỏa selector, và thiết lập cách thức scrape metric từ các đối tượng đó.

Do ServiceMonitor dựa trên Kubernetes API để phát hiện các target (Service, Pod) nằm trong cluster dựa vào label selector và namespace selector, nó không có khả năng monitor trực tiếp các external endpoint bên ngoài cluster.

Nếu muốn monitor các external endpoint, thường làm như sau:

- Không dùng ServiceMonitor mà cấu hình scrape trực tiếp trong config của Prometheus (ví dụ scrape_configs trong prometheus.yml).

- Hoặc dùng một Custom Resource khác như PodMonitor nếu endpoint nằm trong Pods cluster, hoặc cài đặt thêm exporter (ví dụ blackbox exporter) để scrape external endpoint rồi expose metrics này nội bộ cho Prometheus scrape.

<img width="1132" height="374" alt="Screenshot 2025-09-28 135829" src="https://github.com/user-attachments/assets/ffe0f8b7-4cc2-4206-bfb8-b23d88184e46" />

Mối liên hệ
Operator quản lý CRD và xử lý các CR thuộc các loại đã đăng ký.

CRD là cách để mở rộng hệ thống Kubernetes với các loại resource mang "ngôn ngữ domain" cho monitoring (Prometheus CRD, ServiceMonitor, v.v).

CR là khai báo trạng thái mong muốn.

Operator hành động dựa trên CR để tạo/điều chỉnh deployment thực tế: deploy instance, cấu hình scrape, sinh file rule, v.v.

Helm chart chỉ là công cụ đóng gói và tiện lợi để đồng thời deploy tất cả các thành phần này nhanh chóng, nhất là khi triển khai stack phức tạp.

Tóm lại, operator và custom resource phối hợp giúp việc quản lý các hệ thống monitoring phức tạp như Prometheus trên Kubernetes trở nên tự động, dễ mở rộng, dễ maintain hơn rất nhiều so với thao tác thủ công truyền thống.

