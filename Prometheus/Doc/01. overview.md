

# Prometheus architecture
![alt text](https://devopscube.com/content/images/2025/03/prometheus-architecture.gif)

- Prometheus server:
  - có chức năng retrieve data từ target/instance bằng cách gọi đến HTTP URL (VD http://example.com/metrics) và lưu data đấy vào storage. Prometheus hoạt động theo cơ chế pull metric định kỳ.
  - HTTP server cung cấp giao diện web quản trị, API truy vấn PromQL, đường dẫn để xem trạng thái, và đặc biệt là endpoint như /metrics để cung cấp chính các thông số hoạt động của bản thân Prometheus server. Các thành phần khác như Grafana, Prometheus Web UI hoặc API clients có thể truy vấn tới HTTP server bằng PromQL để visualize ra dashboard
- Prometheus targets: là các đối tượng (ví dụ: server, dịch vụ, ứng dụng, exporter) mà Prometheus sẽ chủ động kết nối đến để lấy (scrape) dữ liệu giám sát (metrics) theo định kỳ. Mỗi target phải cung cấp một HTTP endpoint trả về dữ liệu dạng time series, thường là đường dẫn /metrics. Nếu ứng dụng không native hỗ trợ Prometheus thì cần cài thêm exporter (ví dụ node_exporter cho server vật lý, hoặc custom exporter cho database...), hoặc cài thư viện client (ví dụ client_python, client_java...) vào ứng dụng để expose endpoint metrics cho Prometheus scrape
- Pushgateway: đa phần prometheus target không push metric, tuy nhiên có 1 số service mà Prometheus không thể dùng cơ chế pull (VD short-lived service) -> pushgateway là nơi để các service đấy đẩy metric về và lưu lại ở đấy, sau đó chờ Prometheus server pull về
- Service discovery: có 2 cách để khai báo target cần monitor cho Prometheus.
  - Khai báo target trong file cấu hình prometheus.yaml
  - Dùng service discovery. Lưu ý là nếu muốn dùng cơ chế service discovery thì Prometheus cần phải integrate với inventory database (dựa trên k8s, dns, ec2,...)
- Alertmanager: nơi nhận alert

# Cấu hình prometheus
Để cấu hình cho Prometheus thì ta khai báo trong file prometheus.yaml
```yaml
global: #define cho toàn cluster (có thể ghi đè từ target config)
  scrape_interval: 15s    # khoảng thời gian Prometheus scrape metric từ target (có thể ghi đè từ scrape_config)
  evaluation_interval: 15s # khoảng thời gian Prometheus evaluate rule define trong rules file
  scrape_timeout: 10 #khoảng thời gian scrape request bị xem là timeout

rule_files: #chỉ định location của rule file (rule là để tạo time series mới và tạo alert từ time series đấy)
  [ - <filepath_glob> ... ]

alerting: #dùng để set alert
  alert_relabel_configs:
    [ - <relabel_config> ... ]
  alertmanagers:
    [ - <alertmanager_config> ... ]

scrape_configs: #khai báo info và config của target. Ta có thể ghi đè scrape_interval và các giá trị khác tại đây thay cho giá trị global
  - job_name: 'prometheus'  # Giám sát chính Prometheus
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node_exporter'  # Giám sát node_exporter (giám sát máy chủ Linux)
    static_configs:
      - targets: ['localhost:9100']

```

# Basic term
- Sample: là 1 điểm dữ liệu, tức là 1 giá trị tại 1 thời điểm cụ thể của metric

  Ví dụ định dạng một sample: `http_requests_total{method="POST", handler="/login"} 154` nghĩa là tại thời điểm Prometheus thu thập, giá trị của http_requests_total{method="POST", handler="/login"} là 154.
- Timeseries: là một chuỗi các điểm dữ liệu (sample) được ghi nhận liên tiếp qua các mốc thời gian. Mỗi timeseries trong Prometheus được xác định duy nhất bởi:
	- Tên metric (ví dụ: http_requests_total)
	- Một tập các label (cặp key-value, ví dụ: method="POST", handler="/login")
   
  Ví dụ định dạng một timeseries: `http_requests_total{method="POST", handler="/login"}`. 

- Metric: là các chỉ số/quy mô (số liệu) dùng để đo lường trạng thái, hiệu năng, hay các thuộc tính cụ thể của hệ thống hoặc ứng dụng tại một thời điểm. Ví dụ như CPU usage, số lượng request, dung lượng RAM, v.v. Mỗi metric thường có một tên rõ ràng, thể hiện ý nghĩa đo lường, ví dụ: http_requests_total, node_cpu_seconds_total,... Mỗi metric là một tập hợp của nhiều timeseries. Mỗi timeseries sẽ đại diện cho 1 object cần giám sát

  Ví dụ: Metric http_requests_total với các label như method, status, instance sẽ tạo ra nhiều timeseries khác nhau, ví dụ:
	- http_requests_total{method="GET", status="200", instance="web1"}
	- http_requests_total{method="POST", status="500", instance="web2"}

- Target: là server, device,... cần monitor
- Instance: là endpoint cần thu monitor. Ex: 1.2.3.4:5670, 1.2.3.4:5671
- Job: là group của targets hoặc intances có điểm giống nhau
Prometheus quy định một endpoint mà bạn có thể scrape là một *instance*, thường tương ứng với một process đơn. Một nhóm các instance có chung một mục đích, chẳng hạn một process được replicated cho việc mở rồng và độ tin cậy thì được gọi là *job*.
 
Ví dụ, một API server job với 4 replicated instances: 

* job: `api-server`
	* instance 1: `1.2.3.4:5670`
	* instance 2: `1.2.3.4:5671`
	* instance 3: `5.6.7.8:5670`
	* instance 4: `5.6.7.8:5671`

- Exporters: Nếu 1 application muốn đc monitor bởi prometheus, cần add instrumentation vào application code thông qua Prometheus client library. Tuy nhiên nếu ta ko có quyền chỉnh sửa code hoặc cần monitor 1 server -> sử dụng exporter. Nhiệm vụ của exporter là thu thập data theo chỉ định của Prometheus, transform thành định dạng Prometheus cần và gửi về. Có nhiều loại exporter, VD node exporter cho Linux machine (để thu thập metric như CPU, memory, disk space, disk I/O, network bandwidth,...), WM exporter cho Window


Mặc định thì Prometheus chỉ thu thập các số liệu về chính nó (ví dụ số request nhận, memory usabel,...). Để có thể mở rộng thu thập từ các nguồn khác thì cần phải sử dụng Exporter và các công cụ khác để tạo metric và thu thập nó.

Exporter đưuọc phát triển bởi Prometheus và cộng đồng, cung cấp mọi thứ thông tin về cơ sở hạ tầng, cơ sở dữ liệu, web server, hệ thống tin nhắn, API,...

**Một vài các exporter tiêu biểu**:

* **node_exporter**: tạo ra các số liệu về hạ tầng, bao gồm CPU, memoru, disk usage cũng như các số liệu về disk I/O và network.
* **blackbox_exporter**: tạo ra các số liệu từ các đầu dò như HTTP, HTTPs để xác định tính khả dụng của các endpoint, thời gian phản hồi,...
* **mysqld_exporter:** tập hợp các số liệu liên quan đến mysql server
* **rabbitmq_exporter:** output của exporter này liên quan tới RabbitMQ, bao gồm số lượng các message được publish, số message sẵn sàng để gửi, kích thước các gói tin trong hàng đợi.
* **nginx-vts-exporter:**cung cấp các số liệu về ngĩn server sử dụng module VTS bao gồm số lượng kết nối mở, số lượng phản hồi được gửi và tổng kích thước của các gói tin gửi và nhận.

Tìm hiểu thêm một số các exporter [ở đây](https://prometheus.io/docs/instrumenting/exporters/)
