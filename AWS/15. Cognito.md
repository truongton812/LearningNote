AWS Cognito được dùng để quản lý danh tính và xác thực người dùng cho ứng dụng web, mobile, API hoặc backend trên AWS, giúp bạn không phải tự viết lại hệ thống đăng ký, đăng nhập, quản lý user từ đầu.

Cognito tích hợp sẵn với các identity provider như Google, Facebook, Apple, Amazon, SAML, OIDC.

Cognito quản lý hồ sơ user (email, phone, custom attributes) trong User Pool

Luồng hoạt động
- Sau khi đăng nhập thành công, Cognito trả về JWT (ID token, access token, refresh token) để bảo vệ API và frontend.
- Backend có thể dùng token này để xác thực user và phân quyền.

Cognito còn cho phép truy cập tài nguyên AWS bằng cách cấp temporary AWS credentials qua Identity Pool -> người dùng (hoặc guest) truy cập S3, DynamoDB, Lambda, API Gateway… mà không cần access key riêng.


Luồng hoạt động:
- Người dùng truy cập website → frontend sẽ redirect đến Cognito Hosted UI để đăng nhập (ví dụ `https://ap-northeast-17ktlpz92c.auth.ap-northeast-1.amazoncognito.com/login?client_id=5kugln4qrpl8bo843h8cn9q8b2&response_type=code&scope=email+openid+phone&redirect_uri=https%3A%2F%2Ftest-genesis-id.nws-dev.com%2Fhome`)
- Sau khi đăng nhập thành công, Cognito trả về authorization code (là code ở trang return URL, VD `https://test-genesis-id.nws-dev.com/home?code=9e7d87ec-d1cb-4dec-86f8-c3957d4b5d1c`)
- Frontend gửi code kèm code này mỗi khi request lên backend. Backend sẽ gọi lên Cognito endpoint để xác thực xem code có chính xác ko
- Backend nhận request từ frontend, kiểm tra token (JWT) từ Cognito để xác thực user.



làm sao backend biết token là hợp lệ?
Backend biết token là hợp lệ bằng cách verify chữ ký JWT của Cognito, đồng thời kiểm tra một số claim (thời hạn, issuer, audience…). Với Java backend, flow thường như sau:

1. Backend verify JWT như thế nào?
Cognito dùng JWT (RS256) nên backend cần:

Lấy public key tương ứng từ Cognito:

Endpoint:
https://cognito-idp.{region}.amazonaws.com/{user_pool_id}/.well-known/jwks.json

File này chứa các public key (JWK) mà Cognito dùng để ký token.

Xác thực chữ ký JWT

Backend:

Decode JWT để lấy header → xem kid (key ID).

Dùng kid chọn đúng public key trong jwks.json.

Dùng thư viện JWT (ví dụ: java‑jwt hoặc jjwt) để verify chữ ký với public key.

Kiểm tra các claim quan trọng

iss (issuer): phải đúng https://cognito-idp.{region}.amazonaws.com/{user_pool_id}.

exp (expires): phải chưa hết hạn.

token_use: id hoặc access tùy theo bạn dùng token loại gì.

aud / client_id: nếu cần, kiểm tra token đúng app client.

Nếu chữ ký đúng + các claim đúng → token hợp lệ, backend có thể tin các claim bên trong (sub, email, groups…).

2. Cách làm trong Java backend (Spring Boot ví dụ)
Dùng thư viện JWT (ví dụ: java‑jwt hoặc jjwt):

Config một filter / interceptor đọc Authorization: Bearer <token>.

Lấy jwks.json một lần (cache lại), rồi dùng kid để chọn public key đúng.

Dùng sẵn Spring Security + OAuth2 Resource Server (Spring Boot):

Khai báo trong application.yml:

text
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: https://cognito-idp.{region}.amazonaws.com/{user_pool_id}/.well-known/jwks.json
Spring sẽ tự động:

Download JWK.

Verify chữ ký và các claim iss, exp, aud.

3. Backend có nên gọi lại Cognito không?
Không cần gửi token về Cognito để kiểm tra;

Cognito JWT là self‑contained, nên backend chỉ cần verify local bằng public key.

Backend chỉ nên gọi Cognito API nếu cần:

Lấy thêm thông tin user (ví dụ: gọi GetUser), hoặc đổi token sang AWS credentials qua Identity Pool.

Nếu bạn nói rõ đang dùng Spring Boot hay non‑Spring Java (ví dụ Spark/Jersey), có thể đưa ra ví dụ mã Java cụ thể cho filter JWT + verify token từ Cognito.
