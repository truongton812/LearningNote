# Load Balancer

## Instance group
Instance group là group các VM instances. Có thể nhóm các VMs đã tồn tại lại vào 1 instance group

Có 2 loại:
- Managed: các VMs giống nhau (type, image, configure,..) được tạo từ chung 1 instance template. MIG có đủ các tính năng auto scaling, auto healing và managed release (thay đổi phiên bản mà không gây downtime)
- Unmanaged: các VMs có config khác nhau nhưng vẫn có thể gom vào 1 group. UIG không có auto scaling, auto scaling

Instance group chỉ có thể nằm trong 1 region, có thể distribute instances accross multiple zones

Feature của MIG:

- Managed instance group giúp duy trì số lượng instance mong muốn (giống ASG)
- MIG có cơ chế self healing nếu application lỗi (cần cấu hình heal check đến địa chỉ của app). Có thể cấu hình thêm initial delay để loại trừ thời gian app khởi động
- Auto scaling dựa trên workload. Có thể scale bằng các metric như CPU sử dụng, LB metric hoặc metric từ Cloud monitoring. Có thể kiểm soát scale in (VD ko giảm quá 10% instances trong 5 phút)
- Có thể attach với LB để cân bằng tải
- Có thể release new app version mà không gây downtime. Có 2 cơ chế để update instance trong 1 MIG khi ta thay đổi instance template là rolling update và canary (do instance template cần refer đến image nên có thể xem việc update instance template tương đương với update app version)

Lưu ý MIG có 2 loại là stateless (dùng cho các ứng dụng stateless hoặc batch) và statefull (dùng cho database)


### Update instance thuộc MIG
- Là thay đổi instance template của MIG. Có 2 cách là rolling update và canary
  - Rolling update:
    - có thể chỉ định update ngay lập tức (proactive) hoặc khi có cơ hội (Opportuinsitc - khi 1 instance thuộc MIG bị kill hoặc MIG thay đổi số lượng desired instances)
    - có thể chỉ định maximum surge (số lượng instance có thể vượt quá) và maximum unavailable (số lượng instance không khả dụng - cũng đồng nghĩa là số lượng instance có thể update)
  - Rolling restart/replace: không update mà dùng để restart hoặc chỉ đơn giản là muốn replace VM (nhưng vẫn giữ nguyên instance template)
 
## Load Balancer
- Trong GCP, load balancer có thể distribute traffic accross regions
- Các tính năng của load balancer:
  - Healthcheck: chỉ route traffic đến healthy instances. Lưu ý cần cấu hình Firewall rules của instance cho phép health check của LB
  - Autoscaling: scale dựa trên số lượng traffic (?? - là scale LB hay scale số lượng instances)
  - Single anycast IP -> có thể nhận traffic around the world
  - Support internal load balancing
  - SSL/TLS offloading/termination: application không cần xử lý ssl, việc xử lý đẩy hoàn toàn cho LB
 
- Load balancer trong GCP có các type:
  - Application Load Balancer. Có 2 type là classic và advanced
    - Classic: chỉ có 1 mode là global load balancer.
    - Advanced: có thêm nhiều tính năng như modify response/request header, retry failed requests, traffic splitting, traffic metering. Có 2 mode là global và regional load balancer
  - Networking Load Balancer
    
- Các khái niệm khi tạo LB:
  - Backend là các endpoint (máy chủ ảo, Instance Groups, dịch vụ serverless (Cloud Run, App Engine) hoặc Network Endpoint Group - NEG) nhận lưu lượng từ load balancer. Backend là nơi trực tiếp xử lý request.  VD khi dùng microservice thì mỗi microservice sẽ tương ứng với 1 backend. Và do LB trong GCP có thể distribute traffic accross region nên mỗi MIG có thể nằm ở 1 region khác nhau (cần dùng premium tier LB)
  - Backend service là nhóm logical các backends, kiểm soát nhiều đặc tính như loại giao thức (HTTP/HTTPS/TCP/UDP), chính sách phân phối, session persistence, và balancing mode (RATE, CONNECTION, UTILIZATION).​ Khi triển khai một load balancer trên GCP, cần tạo backend service (quy định protocol, balancing mode, health check...) rồi gán backend (VM group, serverless, v.v.) vào backend service đó để phân phối traffic đúng mục tiêu. Một load balancer có thể liên kết với nhiều backend service, mỗi backend service lại chứa một hoặc nhiều backend để phục vụ các nhu cầu khác nhau (ví dụ backend cho traffic HTTP và backend cho traffic TCP).​
  - Host and path rules: dùng để set rule để điều hướng traffic nào đi đến backend nào (có thể set rule theo path, host, http header-method
  - Frontend: giống listeners trong AWS. Là combination của IP, port và protocol. Assign SSL vào đây (cần check lại)

- Cloud Loadbalancing -Feature

| Load Balancer                | Type of Traffic                           | Proxy or pass-through | Destination Ports       |
|------------------------------|-------------------------------------------|----------------------|------------------------|
| External HTTP(S)             | Global, External, HTTP or HTTPS           | Proxy                | HTTP on 80 or 8080<br>HTTPS on 443 |
| Internal HTTP(S)             | Regional, Internal, HTTP or HTTPS         | Proxy                | HTTP on 80 or 8080<br>HTTPS on 443 |
| SSL Proxy                    | Global, External, TCP with SSL offload    | Proxy                | A big list             |
| TCP Proxy                    | Global, External, TCP without SSL offload | Proxy                | A big list             |
| External Network TCP/UDP     | Regional, External, TCP or UDP            | Pass-through         | any                    |
| Internal TCP/UDP             | Regional, Internal, TCP or UDP            | Pass-through         | any                    |

- Cloud Loadbalancing with microservices
