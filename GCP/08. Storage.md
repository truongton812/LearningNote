# Storage

## 1. Block storage
### 1.1. Định nghĩa
- Block storage chia dữ liệu thành các khối (block) có kích thước cố định, mỗi khối có địa chỉ riêng biệt. Hệ thống có thể truy cập và cập nhật từng khối riêng lẻ mà không cần thay đổi toàn bộ dữ liệu. Block storage thường được dùng cho các ứng dụng cần tốc độ cao và độ trễ thấp như cơ sở dữ liệu, máy ảo hoặc hệ thống yêu cầu hiệu suất cao.
- Mỗi volume block storage thường được attach vào một máy chủ hoặc một máy ảo duy nhất tại một thời điểm và thường không có cơ chế để nhiều máy ghi dữ liệu đồng thời vào cùng một volume để tránh lỗi ghi chồng chéo dữ liệu (data corruption) do không có cơ chế đồng bộ ghi giữa các máy.
- Block storage phù hợp khi bạn cần lưu trữ block gắn vào một máy chủ hoặc máy ảo duy nhất để sử dụng như ổ đĩa hệ điều hành, cơ sở dữ liệu hoặc ứng dụng đòi hỏi hiệu suất cao, độ trễ thấp. EBS thường dùng cho các workload cần truy cập dữ liệu nhanh, hay write-intensive, hoặc khi bạn cần kiểm soát chi tiết về block device như định dạng, phân vùng.
- Ví dụ: Ổ cứng (HDD/SSD), SAN (Storage Area Network), Amazon EBS (Elastic Block Store), GCP Persistent disk, GCP Local SSD

### 1.2. GCP Block Storage

GCP cung cấp 2 loại block storage là local SSD và persisten disk

#### 1.2.1. Local SSD
- Là storage được attach trực tiếp vào host của VM instance
- Cung cấp very high IOPS và very low latency
- Lifecycle gắn liền với instance nên chỉ dùng để chứa temp data. Nếu muốn giữ data nếu có maintainance event thì cần enable tính năng "live migration"
- Data tự động được encrypted bằng key của Google (không thể chỉ định key)
- Chỉ hỗ trợ 1 số loại instance
- Không thể detach và attach sang instance khác
- Support 2 loại interfaces là SCSI và NVMe (là interface dùng để connect local SSD với VM). Cần sử dụng image phù hợp (NVMe-enabled image hoặc multi-queue SCSI image)
- Nếu muốn tăng performance thì tăng dung lượng của SSD và tăng số vCPU của VM
- Không hỗ trợ snapshot
- Use case: caches, temp data, scratch file,...

#### 1.2.2. Persistent disk
##### 1.2.2.1. Định nghĩa
- Là storage dùng để chứa peristent data do lifecycle không gắn với instance. Config để giữ lại disk khi xóa instance
- Có thể tạo persistent disk regional hoặc zonal. Regional PDs sẽ được replicated data qua 2 zone khác nhau của 1 region (x2 price so với zonal PDs). Nếu muốn move 1 PD từ zone này sang zone khác để attach với VM ở zone khác thì cần copy sang
- Linh hoạt trong việc tăng giảm size mà không cần detach khỏi instance
- Performance tăng tỉ lệ thuận với size/ số lượng persistent disk/ số vCPU của instance
- Có thể detach và attach sang instance khác
- Có thể tạo image/snapshot/instance từ disk
- Các type persistent disk:
  - Standard: underlying storage là HDD. Giá rẻ nhất. Performance đối với sequential IOPS (dùng cho Big Data/Batch) cao. Performance đối với random IOPS (dùng cho các transactional apps) kém
  - Balanced: underlying storage là SDD. Giá trung bình. Performance đối với sequential IOPS (dùng cho Big Data/Batch) và random IOPS (dùng cho các transactional apps) cao
  - SSD: underlying storage là SDD. Giá cao nhất. Performance đối với sequential IOPS (dùng cho Big Data/Batch) và random IOPS (dùng cho các transactional apps) rất cao
- Persistent disk có thể encrypted bằng Google-managed key hoặc customer-key
##### 1.2.2.2. Persistent disk snapshot
- Snapshot giúp capture lại persistent disk tại 1 thời điểm. Lưu ý snapshot là incremental, tức các bản snapshot sau chỉ lưu lại những thay đổi so với snapshot trước. Việc xóa các bản snapshot chỉ xóa data mà các bản snapshot khác không cần, do đó không ảnh hưởng
- Có thể snapshot thủ công hoặc config schedule snapshot và auto-delete snapshot (Snapshot -> create snapshot schedule -> Attach schedule với disk) . Nên thực hiện snapshot ngoài business hour để tránh ảnh hưởng đến performance
- Snapshot có thể là multi-regional hoặc regional
- Snapshot có thể share giữa các project
- Có thể tạo new disk (Disk -> Source là Snapshot)/ new instance từ snapshot (Snapshot -> Create new instance). Lưu ý chỉ tạo được instance nếu là snapshot từ boot disk

##### 1.2.2.3. Cách mount Persistent disk vào VM instance

- Attach Disk vào instance đang running hoặc stopped bằng command `gcloud compute instances attach-disk INSTANCE_NAME --disk DISK_NAME`
- Format diskFormat the disk
  - List các disk đang gắn với instance bằng lệnh `sudo lsblk`
  - Format theo định dạng, VD ext4 bằng lệnh `sudo mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/sdb`
- Mount disk vào thư mục bằng lệnh `sudo mount -o discard,defaults /dev/sdb /mnt/disks/MY_DIR`

##### 1.2.2.4. Resizing Persistent Disks
- Có thể resize kể cả khi instance đang running bằng lệnh `gcloud compute disks resize DISK_NAME --size DISK_SIZE`
- Take a snapshot (optional)
- Resize file system và partitions. VD ext4: `sudo resize2fs /dev/sdb` hoặc xfs: `sudo xfs_growfs /dev/sdb`
  
##### 1.2.2.5. Image
- Image là thành phần được tạo ra từ boot disk/instance
- Có thể tạo snapshot từ image. Lưu ý việc tạo snapshot từ image sẽ mất thời gian hơn tạo snapshot từ disk. Tuy nhiên tạo disk từ image sẽ nhanh hơn tạo disk từ snapshot.
  
##### 1.2.2.6. Machine images
- Multiple disk (boot disk và data disk) có thể attach vào cùng 1 VM -> nếu muốn backup multiple disk thì dùng machine image
- Machine image chứa tất cả những gì cần thiết để tạo VM instance (config, metadata, permission của VM instance, và data từ tất cả các disk)
- Machine image dùng khi muốn clone hoặc replicate 1 VM instance
- Machine image có thể encrypt bằng key của customer

## 2. File Storage
## 2.1. Định nghĩa
- File storage tổ chức dữ liệu theo dạng tệp (file) và thư mục (folder), giống như hệ thống tập tin trên máy tính. Người dùng có thể dễ dàng truy cập, chia sẻ và quản lý dữ liệu thông qua cấu trúc cây thư mục.
- File storage hỗ trợ nhiều máy tính cùng truy cập và ghi dữ liệu đồng thời vào cùng một hệ thống lưu trữ file mà không gặp xung đột
- File Storage thích hợp khi bạn cần một hệ thống file chia sẻ, có thể truy cập đồng thời bởi nhiều máy chủ hoặc container trong mạng. EFS phù hợp cho ứng dụng như lưu trữ dữ liệu dùng chung của web servers, ứng dụng phân tán, hoặc môi trường container, nơi nhiều client cần truy cập cùng lúc.
- Ví dụ: Máy tính cá nhân, NFS (Linux), SMB/CIFS (Window), NAS (Network Attached Storage), Google Drive, Dropbox, GCP FileStore, EFS

## 2.2. GCP Filestore
- Là file storage cung cấp bởi GCP, tương tự EFS của AWS
- Có thể share giữa nhiều instance hoặc dùng trong cụm GCP K8S
- Hỗ trợ NFSv3 protocol
- Cần provision capacity
- Tối đa 320 TB, throughput max 16GB/s và 480k IOPS
- Hỗ trợ cả HDD và SDD

## 3. Object Storage
### 3.1. Định nghĩa
- Object storage lưu trữ dữ liệu dưới dạng các đối tượng (object), mỗi đối tượng gồm dữ liệu, metadata (thông tin mô tả) và một định danh duy nhất. Object storage phù hợp cho lưu trữ dữ liệu phi cấu trúc, dung lượng lớn và cần mở rộng linh hoạt.
- Ví dụ: Amazon S3, Google Cloud Storage, các hệ thống lưu trữ ảnh, video, backup dữ liệu lớn


### 3.2. Cloud storage
- Là dịch vụ object storage của GCP. Mỗi bucket gắn liền với 1 project
- Có thể store nhiều loại file: text, media, binary, application packages, backup (VD move backup database từ onprem vào GCP, sau đó import vào GCP database), archive
- Dung lượng tối đa object trong bucket là 5 TB
- Để tương tác với Cloud Storage bằng CLI thì dùng gsutil

#### 3.2.1. Storage class
Cloud storage có các storage class (là cách phân loại object dựa vào tần suất truy cập để tiết kiệm chi phí):
  - Standard: dành cho các object thường xuyên truy cập. Không bị charge chi phí tối thiểu
  - Nearline: dành cho các object truy cập 1 tháng 1 lần. Bị charge chi phí tối thiểu là 30 ngày
  - Coldline: dành cho các object truy cập 1 quý 1 lần. Bị charge chi phí tối thiểu là 90 ngày
  - Archive: dành cho các object truy cập 1 năm 1 lần. Bị charge chi phí tối thiểu là 365 ngày
- Có thể config storage class ở bucket level và object level. 


#### 3.2.2. Object versioning
- Cần enable ở bucket level để sử dụng, là tính năng cho phép 1 object có nhiều version -> đảm bảo không bị xóa nhầm và cung cấp history của object
- Nếu xóa versioned object thì chỉ ẩn object đi chứ không thực sự xóa
- Với versioned object thì live version là latest version. Nếu xóa live version thì object sẽ trở thành noncurrent object version. Và khi xóa noncurrent object version thì object sẽ thực sự bị xóa
- Để truy cập old version thì dùng tổ hợp key+version

#### 3.2.3. Object lifecycle management
- Là tính năng tự động quản lý vòng đời của các objects trong bucket dựa trên các quy tắc do người dùng định nghĩa. Khi các objects thỏa mãn các điều kiện nhất định, hệ thống sẽ tự động thực hiện các hành động như chuyển đổi lớp lưu trữ sang loại rẻ hơn hoặc xóa đối tượng để tối ưu chi phí và quản lý dữ liệu hiệu quả.
- Các điều kiện có thể áp dụng bao gồm: Age (tuổi của object - tính từ ngày tạo), isLive (trạng thái hoạt động của object - live hay không), MatchesStorageCLass (storage class hiện tại),.... Có thể define nhiều điều kiện, object phải thỏa mãn tất cả các điều kiện mới thực hiện action.
- Hành động chính gồm xoá object hoặc thay đổi Storage Class. Với thay đổi Storage Class, cho phép thay đổi:
  - Từ Standard/Multi-Regional/Regional sang Nearline/Coldline/Archive
  - Từ Nearline sang Coldline/Archive
  - Từ Coldline sang Archive
- Tính năng Object Lifecycle Management﻿ trong Google Cloud Storage được cấu hình ở cấp độ bucket. Vào Bucket -> Chọn `lifecycle` và `add a rule`
- Ví dụ rule của Object Lifecycle Management
```
{
  "lifecycle": {
    "rule": [
      {
        "action": { "type": "Delete" },
        "condition": {
          "age": 30,
          "isLive": true
        }
      },
      {
        "action": {
          "type": "SetStorageClass",
          "storageClass": "NEARLINE"
        },
        "condition": {
          "age": 365,
          "matchesStorageClass": ["STANDARD"]
        }
      }
    ]
  }
}
```
#### 3.2.3. Cloud storage encryption
- Mặc định tất cả các object lưu trữ trong Cloud Storage đều được mã hóa bởi GCP
- Các loại mã hóa có thể thực thi
  - Google-managed: là mã hóa mặc định, sử dụng key của Google
  - Customer-managed: là mã hóa sử dụng key do người dùng tạo ra trong Cloud KMS. Lưu ý khi sử dụng Customer-managed thì cần cấp cho Cloud Storage Service Account quyền sử dụng key
  - Customer-supplied: người dùng tự cung cấp key và cần gửi key đấy kèm theo mỗi lần thao tác với GCS (upload/download…), GCS sẽ dùng key đấy để mã hóa và giải mã. Lưu ý GCS không lưu trữ key này nên sẽ không khôi phục được dữ liệu nếu mất key. Cách cung cấp key cho GCS:
    - Nếu gọi API thì truyền key qua các HTTP header như: x-goog-encryption-algorithm, x-goog-encryption-key (key đã Base64), x-goog-encryption-key-sha256 (hash của key).
    - Nếu dùng gsutil thì cấu hình encryption_key trong section GSUtil của file cấu hình boto
  - Client-side encryption: việc encrypt và decrypt thực hiện hoàn toàn ở phía client

#### 3.2.4. Cloud storage bucket lock
- Là tính năng quy định thời gian tối thiểu mà các object phải được giữ lại trước khi có thể xóa hoặc ghi đè. Một khi đã lock retention policy, việc giảm thời gian lưu giữ hoặc xóa policy trở nên vĩnh viễn không thể đảo ngược, đảm bảo bucket chỉ xóa được khi mọi object đạt hết hạn retention.
- Bucket lock áp dụng cho cả object hiện tại và mới thêm vào. 
- Có thể set khi tạo bucket hoặc sau khi tạo bucket​
- Cách thực hiện: chọn "Retention" -> chọn "Retention perid"

#### 3.2.5. Transfer data từ on-prem lên Google Cloud
- Storage Transfer Service là dịch vụ giúp chuyển dữ liệu giữa các hệ thống lưu trữ object/file, bao gồm từ on-premises, AWS, Azure sang Google Cloud Storage hoặc giữa các bucket. 
- Tính năng chuyển linh hoạt:
  - Hỗ trợ lọc prefix
  - Bảo toàn metadata
  - Incremental transfer - chỉ copy file mới/cập nhật/xóa
  - Reliable và fault tolerant: trong trường hợp gặp lỗi chỉ tiếp tục từ điểm lỗi
- Bảo mật: Mã hóa TLS, checksum CRC32C kiểm tra tính toàn vẹn, VPC Service Controls​
- Schedule: Lên lịch 1 lần hoặc lặp lại
- Giá cả và use case: Miễn phí cho chuyển từ cloud khác; $0.0125/GB cho on-premises agents; chỉ tính lưu trữ Cloud Storage sau chuyển.​
- Lưu ý: gsutil cũng có thể dùng để transfer data nhưng chỉ recommand cho trường hợp chuyển dưới 1TB dữ liệu từ on-prem hoặc giữa các GCS buckets

#### 3.2.6. Cloud storage best practice

**Exponential backoff cho lỗi 5xx / 429**
- Khi gặp lỗi 5xx (server error) hoặc 429 (too many requests) thì thường là do hệ thống đang quá tải tạm thời, không phải lỗi vĩnh viễn.
- Exponential backoff nghĩa là mỗi lần retry sẽ tăng thời gian chờ lên theo cấp số nhân: 1, 2, 4, 8, 16 giây… thay vì spam request liên tục. Điều này giúp giảm áp lực lên server và tăng khả năng request thành công ở lần retry sau.

**Không dùng key tuần tự / timestamp**
- Nếu dùng object key dạng tăng dần (1, 2, 3…) hoặc timestamp thẳng (20251202120001...) thì nhiều object mới sẽ “dồn” vào cùng một vùng trong hệ thống, dễ gây hotspot, giảm throughput.
- Cloud Storage khuyến nghị: Dùng tên object ngẫu nhiên (random) hoặc ít nhất thêm một đoạn hash ngẫu nhiên vào trước số thứ tự/timestamp, ví dụ: a9f3_20251202_120001.log để phân tán đều load.

**Dùng Cloud Storage FUSE**
- Cloud Storage FUSE cho phép mount bucket như một file system trên Linux/macOS và thao tác bằng lệnh file bình thường (ls, cp, mv) hoặc qua ứng dụng mà không cần tự viết logic gọi API.
- Rất hữu ích cho workload cần đọc/ghi từ “thư mục” nhưng thực ra muốn dùng Cloud Storage làm backend, ví dụ backup, xử lý batch, hoặc migrate dữ liệu giữa local và Cloud Storage.

#### 3.2.7. Gsutil command

Các lệnh làm việc với Cloud Storage bằng gsutil command

`gsutil mb gs://<bucket_name>` : tạo bucket

`gsutil ls -a gs://<bucket_name>` : list các objects, option `-a` để list các version của object

`gsutil cp gs://<source_bucket>/<source_object> gs://<dest_bucket>/<name_copy>` : copy object giữa các object, thêm option `-o 'GSUtil:encryption_key=<key>'` để chỉ định encryption key

`gsutil mv gs://<bucket_name>/<old_object_name> gs://<bucket_name>/<new_object_name>` : đổi tên object

`gsutil mv gs://<old_bucket_name>/<old_object_name> gs://<new_bucket_name>/<new_object_name>` : di chuyển object

`gsutil rewrite -s <storage_class> gs://<bucket_name>/<object_path>` : thay đổi storage class của object

`gsutil cp <local_path> gs://<bucket_name>/` : upload object từ local lên Cloud Storage

`gsutil cp gs://<bucket_name>/<object_path> <local_path>` : download object từ Cloud Storage về local

`gsutil versioning set on/off gs://<bucket_name>` :  Enable/Disable bucket versioning

`gsutil uniformbucketlevelaccess set on/off gs://<bucket_name>` : Enable/Disable tính năng "uniform bucket-level access" (là tính năng chỉ sử dụng IAM để cấp quyền truy cập, vô hiệu hóa hoàn toàn Access Control Lists)

`gsutil acl ch` : set access permission cho object. VD:
- `gsutil acl ch -u AllUsers:READ gs://<bucket_name>/<object_path>` : cho phép tất cả đọc object
- `gsutil acl ch -u john.doe@example.com:WRITE gs://<bucket_name>/<object_path>` : chỉ cho phép user john.doe@example.com ghi. Ngoài READ,WRITE còn có OWNER

`gsutil signurl -d 10m <your_key> gs://<bucket_name>/<object_path>` : tạo signed URL cho truy cập tạm thời
